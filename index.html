<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>トラパレ</title>
    <style>
        /* --- 全体設定 --- */
        * { box-sizing: border-box; } 
        
        html, body { 
            height: 100%; width: 100%; margin: 0; padding: 0;
            font-family: "Helvetica Neue", Arial, sans-serif; 
            background: #e0e4e8; 
            overflow: hidden; 
        }

        body {
            display: flex; 
            flex-direction: row; /* デフォルトはPC（横並び） */
        }
        
        /* --- 共通パーツ --- */
        h2 { margin: 0 0 5px 0; font-size: 15px; color: #2c3e50; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .column-header { font-size: 11px; font-weight: bold; color: #7f8c8d; text-transform: uppercase; margin-bottom: 5px; display: block; margin-top: 10px;}
        
        button { cursor: pointer; border: 1px solid #ccc; background: #f8f9fa; border-radius: 4px; font-size: 13px; transition: all 0.1s; }
        button:hover { background: #e9ecef; }
        button:active { transform: translateY(1px); }

        input[type="number"], select { padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        input[type="number"] { width: 70px; text-align: right; }
        select { width: 100%; }

        /* --- PC用レイアウト (3カラム) --- */
        /* PCでは常に全部表示。orderプロパティで並び順を保証 */
        #left-col {
            width: 270px; min-width: 270px; background: #fff; border-right: 1px solid #ccc; padding: 15px;
            display: flex; flex-direction: column; gap: 5px; z-index: 10; overflow-y: auto;
            order: 1; 
        }

        #center-col {
            flex: 1;
            background: #cbd3da;
            position: relative;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            padding: 60px 20px 20px 20px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
            order: 2; 
        }

        #right-col {
            width: 270px; min-width: 270px; background: #fff; border-left: 1px solid #ccc; padding: 15px;
            display: flex; flex-direction: column; gap: 8px; z-index: 10; overflow-y: auto;
            order: 3; 
        }

        /* PCではモバイル用パーツを隠す */
        #mobile-tabs { display: none; }
        .mobile-only { display: none; }

        /* --- UIパーツ --- */
        .truck-btn { padding: 10px; text-align: left; display: flex; flex-direction: column; gap: 2px; width: 100%; margin-bottom: 5px; border: 1px solid #ccc; background: #fff;}
        .truck-btn strong { color: #333; font-size: 13px; }
        .truck-btn small { color: #666; font-size: 10px; }
        .truck-btn.active { background: #2c3e50; border-color: #1a252f; }
        .truck-btn.active strong { color: #fff; }
        .truck-btn.active small { color: #bbb; }

        .custom-area { background: #f1f8ff; padding: 10px; border-radius: 4px; border: 1px dashed #aaddff; margin-bottom: 10px; }
        
        .input-group { display: flex; align-items: center; gap: 5px; margin-bottom: 6px; font-size: 12px; }
        .input-group label { flex: 1; color: #555; font-weight: bold; }
        
        .setting-box { background: #fff3cd; border: 1px solid #ffeeba; padding: 8px; border-radius: 4px; margin-bottom: 5px; }
        .setting-box.blue { background: #e8f5e9; border-color: #c8e6c9; }

        .btn-apply { width: 100%; background: #3498db; color: white; border: none; padding: 8px; margin-top: 4px; font-size: 12px; border-radius: 4px;}

        #pallet-buttons-container { display: flex; flex-wrap: wrap; gap: 5px; }
        .pallet-btn { 
            padding: 10px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            border: 1px solid #ccc; background: #fff; height: 55px;
        }
        .pallet-btn.full { width: 100%; }
        .pallet-btn.half { width: calc(50% - 2.5px); }
        .pallet-btn strong { font-size: 13px; display: block; }
        .pallet-btn small { font-size: 10px; color: #666; display: block; margin-top: 2px;}

        .action-area { display: flex; gap: 8px; margin-top: 10px; }
        .action-btn { flex: 1; padding: 10px; font-weight: bold; font-size: 12px; }
        .btn-undo { background: #fff0f0; border-color: #ffcccc; color: #c0392b; }
        .btn-clear { background: #fff3cd; border-color: #ffeeba; color: #856404; }

        #status-box { margin-top: auto; padding: 12px; background: #f1f8ff; border: 1px solid #cce5ff; border-radius: 6px; font-size: 12px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px solid #eef; padding-bottom: 4px;}
        .breakdown { margin-top: 8px; padding-top: 8px; border-top: 1px solid #dae0e5; font-size: 11px; color: #444; line-height: 1.4; }
        
        .text-over { color: #d00; font-weight: bold; }
        .error-msg { color: #e74c3c; font-weight: bold; font-size: 11px; margin-top: 6px; text-align: center; min-height:1em;}

        /* --- 荷台描画 --- */
        #truck-bed {
            background-color: #f4f4f4; border: 2px solid #333; border-top: 10px solid #2c3e50;
            position: relative; box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            transition: width 0.3s, height 0.3s; box-sizing: content-box; 
        }
        .bed-header { position: absolute; top: -50px; left: 0; width: 100%; text-align: center; pointer-events: none; line-height: 1.4; white-space: nowrap; }
        .header-label { font-size: 11px; color: #666; font-weight: bold; display: block; }
        .header-name { font-size: 15px; color: #2c3e50; font-weight: bold; display: block; }

        /* --- パレット --- */
        .pallet {
            position: absolute; box-sizing: border-box; display: flex; 
            justify-content: center; align-items: center; flex-direction: column;
            color: #fff; font-weight: bold; border: 1px solid rgba(0,0,0,0.2);
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.25); z-index: 10; overflow: hidden;
            white-space: nowrap; line-height: 1.1;
        }
        .pallet.type-11 { background-color: #2980b9; } 
        .pallet.type-12 { background-color: #8e44ad; } 
        .pallet.type-14 { background-color: #c0392b; }
        .pallet.type-9  { background-color: #f39c12; color: #333; }
        .pallet.type-custom { background-color: #27ae60; } 
        
        .pallet.preview { opacity: 0.6; border: 2px dashed #333; background-color: rgba(100, 100, 100, 0.5) !important; color: #fff; z-index: 20; pointer-events: none; }

        /* 荷主ラベル (PC用) */
        .owner-tag {
            position: absolute; top: 0; left: 0; width: 24px; height: 24px;
            color: #fff; font-size: 12px; font-weight: bold;
            display: flex; justify-content: center; align-items: center;
            border-bottom-right-radius: 4px; box-shadow: 1px 1px 2px rgba(0,0,0,0.3); z-index: 2;
        }
        .owner-tag.owner-A { background-color: #e74c3c; } 
        .owner-tag.owner-B { background-color: #e67e22; } 
        .owner-tag.owner-C { background-color: #2ecc71; } 
        .owner-tag.owner-D { background-color: #f1c40f; color:#333; } 
        .owner-tag.owner-E { background-color: #34495e; } 

        .p-index { font-size: 12px; display: block; z-index: 1; }
        .p-size { font-size: 10px; opacity: 0.9; display: block; z-index: 1; }
        .p-weight { font-size: 10px; opacity: 0.9; display: block; color: #ffeb3b; z-index: 1; }

        /* =========================================
           スマホ完全対応 (CSSメディアクエリ)
           ========================================= */
        @media screen and (max-width: 768px) {
            body {
                flex-direction: column !important; /* 縦積み強制 */
            }

            /* --- タブメニュー (最上部固定) --- */
            #mobile-tabs {
                display: flex !important; height: 50px; width: 100%; flex: none; 
                background: #f8f9fa; border-bottom: 1px solid #ccc; z-index: 200; order: 1;
            }
            .tab-btn {
                flex: 1; border: none; background: transparent; color: #888;
                font-weight: bold; font-size: 14px; border-bottom: 3px solid transparent; border-right: 1px solid #ddd;
            }
            .tab-btn:last-child { border-right: none; }
            /* アクティブなタブのデザイン */
            body.view-truck #tab-truck, 
            body.view-pallet #tab-pallet {
                background: #fff;
                color: #2c3e50;
                border-bottom: 3px solid #2c3e50;
            }

            /* --- 描画エリア (上段) --- */
            #center-col {
                order: 2; height: 40%; width: 100%; flex: none; 
                padding: 50px 10px 10px 10px; border-bottom: 1px solid #aaa;
                z-index: 2; background: #cbd3da;
                /* デフォルト(truckモード)では非表示 */
                display: none; 
            }

            /* --- 操作パネル (下段) --- */
            #left-col, #right-col {
                order: 3; width: 100% !important; flex: 1; padding: 15px;
                overflow-y: auto; -webkit-overflow-scrolling: touch; 
                border: none;
                /* デフォルト非表示 */
                display: none;
            }

            /* --- 表示ロジック (CSSでスイッチ) --- */
            
            /* 【モードA: 荷台設定 (bodyにクラスなし or view-truck)】 */
            body:not(.view-pallet) #left-col { display: flex !important; }
            body:not(.view-pallet) #center-col { display: none !important; }
            body:not(.view-pallet) #right-col { display: none !important; }
            body:not(.view-pallet) #tab-truck { background: #fff; color: #2c3e50; border-bottom: 3px solid #2c3e50; }

            /* 【モードB: パレット配置 (body.view-pallet)】 */
            body.view-pallet #center-col { display: flex !important; }
            body.view-pallet #right-col { display: flex !important; }
            body.view-pallet #left-col { display: none !important; }

            .mobile-only { display: block !important; }

            /* ★★★ スマホ専用：荷主カラー＆シンプル表示 ★★★ */
            
            /* 荷主ラベル(タグ)はスマホでは消す */
            .pallet[class*="owner-"] .owner-tag { display: none !important; }

            /* パレット本体の色を荷主カラーで上書き */
            .pallet.owner-A { background-color: #e74c3c !important; color: #fff; }
            .pallet.owner-B { background-color: #e67e22 !important; color: #fff; }
            .pallet.owner-C { background-color: #2ecc71 !important; color: #fff; }
            .pallet.owner-D { background-color: #f1c40f !important; color: #333 !important; }
            .pallet.owner-E { background-color: #34495e !important; color: #fff; }

            /* スマホ文字調整 */
            .p-size, .p-weight { display: none !important; } /* サイズと重量は消す */
            .p-index { 
                font-size: 18px !important; /* 数字を大きく */
                font-weight: bold;
                margin: auto; /* 中央寄せ */
            }
        }
    </style>
</head>
<body>

    <div id="mobile-tabs">
        <button class="tab-btn" id="tab-truck" onclick="switchMode('truck')">1. 荷台設定</button>
        <button class="tab-btn" id="tab-pallet" onclick="switchMode('pallet')">2. パレット配置</button>
    </div>

    <div id="left-col">
        <h2>使用する荷台を選択</h2>
        <span class="column-header" style="margin-top:0;">定型サイズ</span>
        <div id="truck-buttons"></div>
        
        <div class="setting-box">
            <div class="input-group">
                <label>最大積載量 (kg)</label>
                <input type="number" id="truck-capacity" value="0" onchange="updateCapacityDisplay()">
            </div>
        </div>

        <span class="column-header">カスタム (mm)</span>
        <div class="custom-area">
            <div class="input-group"><label style="flex:1;">長さ(縦)</label><input type="number" id="custom-truck-l" value="8000" step="100"></div>
            <div class="input-group"><label style="flex:1;">車幅(横)</label><input type="number" id="custom-truck-w" value="2300" step="10"></div>
            <button class="btn-apply" onclick="setCustomTruck()">適用して次へ</button>
        </div>

        <div class="mobile-only" style="margin-top:20px; text-align:center; color:#888; font-size:12px; background:#f0f0f0; padding:10px; border-radius:5px;">
            荷台を決めたら、上のタブで<br>「2. パレット配置」へ移動してください
        </div>
        <div style="height:50px;"></div>
    </div>

    <div id="center-col">
        <div id="truck-bed" style="display:none;"></div>
    </div>

    <div id="right-col">
        <h2>パレットを追加</h2>
        
        <div class="setting-box blue">
            <div class="input-group">
                <label>重量(kg)</label>
                <input type="number" id="pallet-weight" value="0" placeholder="0">
            </div>
            <div class="input-group">
                <label>荷主(ラベル)</label>
                <select id="owner-select" style="flex:1; margin-left:5px;">
                    <option value="default">指定なし</option>
                    <option value="A">荷主A (赤)</option>
                    <option value="B">荷主B (橙)</option>
                    <option value="C">荷主C (緑)</option>
                    <option value="D">荷主D (黄)</option>
                    <option value="E">荷主E (黒)</option>
                </select>
            </div>
        </div>

        <span class="column-header" style="margin-top:0;">定型パレット</span>
        <div id="pallet-buttons-container"></div>
        
        <span class="column-header">カスタム (mm)</span>
        <div class="custom-area">
            <div class="input-group"><label>幅(横)</label><input type="number" id="custom-pallet-w" value="1100" step="10"></div>
            <div class="input-group"><label>奥行(縦)</label><input type="number" id="custom-pallet-d" value="1100" step="10"></div>
            <button class="btn-apply" id="btn-add-custom" style="background:#27ae60;">＋ 追加</button>
        </div>

        <div class="action-area">
            <button class="action-btn btn-undo" onclick="undoLastPallet()">↩ 戻る</button>
            <button class="action-btn btn-clear" onclick="clearAll()">✖ クリア</button>
        </div>

        <div id="status-box">
            <div class="stat-row"><span>合計枚数:</span><strong id="count" style="font-size:1.2em;">0 枚</strong></div>
            <div class="stat-row">
                <span>積載重量:</span>
                <span id="weight-display" style="text-align:right;">0 / 0 kg (0%)</span>
            </div>
            <div class="stat-row"><span>残り長さ (L/R):</span><span id="remain-len">- / -</span></div>
            <div class="breakdown" id="breakdown-list">(内訳)</div>
            <div id="error-msg" class="error-msg"></div>
        </div>
        <div style="height:50px;"></div>
    </div>

<script>
    // --- データ ---
    const TRUCKS = [
        { name: "2t 標準",    L: 3100, W: 1780, cap: 2000 },
        { name: "2t ワイドL", L: 4310, W: 2095, cap: 2000 },
        { name: "4t 標準",    L: 5935, W: 2185, cap: 3950 },
        { name: "4t ワイド",  L: 5935, W: 2365, cap: 3850 },
        { name: "10t ワイド", L: 9640, W: 2410, cap: 14700 }
    ];

    const PALLETS = [
        { id: '11',  name: "11型 正方形", w: 1100, d: 1100, typeClass: 'type-11', widthType: 'full' },
        { id: '12v', name: "12型 縦",     w: 1000, d: 1200, typeClass: 'type-12', widthType: 'half' },
        { id: '12h', name: "12型 横",     w: 1200, d: 1000, typeClass: 'type-12', widthType: 'half' },
        { id: '14v', name: "14型 縦",     w: 1100, d: 1400, typeClass: 'type-14', widthType: 'half' },
        { id: '14h', name: "14型 横",     w: 1400, d: 1100, typeClass: 'type-14', widthType: 'half' },
        { id: '9v',  name: "9型 縦",      w: 900,  d: 1100, typeClass: 'type-9', widthType: 'half' },
        { id: '9h',  name: "9型 横",      w: 1100, d: 900,  typeClass: 'type-9', widthType: 'half' }
    ];

    let currentScale = 0.085; 
    let state = { currentTruck: null, history: [], truckIndex: -1, currentCapacity: 0 };

    const dom = {
        body: document.body,
        centerCol: document.getElementById('center-col'),
        truckBed: document.getElementById('truck-bed'),
        truckBtns: document.getElementById('truck-buttons'),
        palletBtnsContainer: document.getElementById('pallet-buttons-container'),
        count: document.getElementById('count'),
        remainLen: document.getElementById('remain-len'),
        weightDisplay: document.getElementById('weight-display'),
        breakdown: document.getElementById('breakdown-list'),
        errorMsg: document.getElementById('error-msg'),
        customTruckL: document.getElementById('custom-truck-l'),
        customTruckW: document.getElementById('custom-truck-w'),
        truckCapacity: document.getElementById('truck-capacity'),
        customPalletW: document.getElementById('custom-pallet-w'),
        customPalletD: document.getElementById('custom-pallet-d'),
        palletWeight: document.getElementById('pallet-weight'),
        ownerSelect: document.getElementById('owner-select'),
        btnAddCustom: document.getElementById('btn-add-custom'),
    };

    function init() {
        createButtons();
        setupCustomEvents();
        window.addEventListener('resize', onResize);
    }

    function isMobile() {
        return window.innerWidth <= 768;
    }

    // ★シンプルになったモード切替★
    window.switchMode = function(mode) {
        if (mode === 'truck') {
            dom.body.classList.remove('view-pallet');
        } else {
            dom.body.classList.add('view-pallet');
            // 切り替わった瞬間にリサイズ計算
            setTimeout(() => onResize(), 50);
        }
    };

    function onResize() {
        if(state.currentTruck) {
            calculateAutoScale();
            updateTruckView();
            recalculateAndRender();
        }
    }

    function createButtons() {
        TRUCKS.forEach((t, i) => {
            const btn = document.createElement('button');
            btn.className = 'truck-btn';
            btn.innerHTML = `<strong>${t.name}</strong><small>${t.L}×${t.W}</small>`;
            btn.onclick = () => selectTruck(i, btn);
            dom.truckBtns.appendChild(btn);
        });

        PALLETS.forEach(p => {
            const btn = document.createElement('button');
            const sizeClass = (p.widthType === 'full') ? 'full' : 'half';
            btn.className = `pallet-btn ${sizeClass}`;
            const nameShort = p.name.replace('型 ', '型<br>');
            btn.innerHTML = `<strong>${nameShort}</strong><small>${p.w}×${p.d}</small>`;
            
            btn.onclick = () => addPalletRequest(p);
            btn.onmouseenter = () => { if(!isMobile()) showPreview(p); };
            btn.onmouseleave = () => hidePreview();

            dom.palletBtnsContainer.appendChild(btn);
        });
    }

    function setupCustomEvents() {
        dom.btnAddCustom.onclick = () => {
            const w = parseInt(dom.customPalletW.value) || 0;
            const d = parseInt(dom.customPalletD.value) || 0;
            if (w <= 0 || d <= 0) return;
            const p = { id: 'custom', name: `カスタム(${w}x${d})`, w: w, d: d, typeClass: 'type-custom' };
            addPalletRequest(p);
            if(!isMobile()) showPreview(p);
        };
        dom.btnAddCustom.onmouseenter = () => {
            if(isMobile()) return; 
            const w = parseInt(dom.customPalletW.value) || 0;
            const d = parseInt(dom.customPalletD.value) || 0;
            if (w > 0 && d > 0) {
                const p = { id:'custom', name:'Custom', w:w, d:d, typeClass:'type-custom' };
                showPreview(p);
            }
        };
        dom.btnAddCustom.onmouseleave = () => hidePreview();
    }

    window.updateCapacityDisplay = function() {
        const val = parseInt(dom.truckCapacity.value) || 0;
        state.currentCapacity = val;
        recalculateAndRender(); 
    };

    function calculateAutoScale() {
        if (!state.currentTruck) return;
        const paddingH = isMobile() ? 60 : 80; 
        const paddingW = 40; 
        const containerH = dom.centerCol.clientHeight - paddingH;
        const containerW = dom.centerCol.clientWidth - paddingW;
        if(containerH <= 0 || containerW <= 0) return;
        const scaleH = containerH / state.currentTruck.L;
        const scaleW = containerW / state.currentTruck.W;
        currentScale = Math.min(scaleH, scaleW) * 0.90;
    }

    function selectTruck(index, btnElem) {
        const t = TRUCKS[index];
        state.currentTruck = t;
        state.truckIndex = index;
        state.currentCapacity = t.cap;
        dom.truckCapacity.value = t.cap; 
        
        clearAllLogic(); 
        Array.from(dom.truckBtns.children).forEach(b => b.classList.remove('active'));
        if(btnElem) btnElem.classList.add('active');
        
        setTimeout(() => { calculateAutoScale(); updateTruckView(); }, 50);
    }

    function setCustomTruck() {
        const L = parseInt(dom.customTruckL.value);
        const W = parseInt(dom.customTruckW.value);
        if (!L || !W || L<=0 || W<=0) { showError("サイズNG"); return; }

        state.currentTruck = { name: "カスタム荷台", L: L, W: W };
        state.truckIndex = -1;
        state.currentCapacity = 0;
        dom.truckCapacity.value = 0;
        
        clearAllLogic();
        Array.from(dom.truckBtns.children).forEach(b => b.classList.remove('active'));

        setTimeout(() => { calculateAutoScale(); updateTruckView(); }, 50);
    }

    function addPalletRequest(palletProto) {
        if (!state.currentTruck) { 
            if(isMobile()) { showError("◀ 荷台を選んでください"); switchMode('truck'); } 
            else { showError("◀ 荷台を選択してください"); }
            return; 
        }
        
        const currentWeight = parseInt(dom.palletWeight.value) || 0;
        const currentOwner = dom.ownerSelect.value; 

        const newPallet = { 
            ...palletProto, 
            weight: currentWeight,
            owner: currentOwner 
        };
        
        const newHistory = [...state.history, newPallet];
        const result = calculateLayout(state.currentTruck, newHistory);

        if (result.success) {
            state.history = newHistory;
            renderResult(result);
            showError("");
        } else {
            showError("長さオーバーです");
        }
    }

    function undoLastPallet() {
        if (state.history.length === 0) return;
        state.history.pop();
        recalculateAndRender();
        showError("");
    }

    function clearAll() {
        if (!state.currentTruck) return;
        clearAllLogic();
    }

    function clearAllLogic() {
        state.history = [];
        recalculateAndRender();
        showError("");
    }

    function calculateLayout(truck, palletList) {
        let placedItems = [];
        let leftY = 0;
        let rightY = 0;

        for (let i = 0; i < palletList.length; i++) {
            const p = palletList[i];
            let x, y;

            if (p.w * 2 <= truck.W) {
                if (leftY <= rightY) {
                    x = 0; y = leftY;
                    if (y + p.d > truck.L) return { success: false };
                    leftY += p.d;
                } else {
                    x = truck.W - p.w; y = rightY;
                    if (y + p.d > truck.L) return { success: false };
                    rightY += p.d;
                }
            } else {
                let startY = Math.max(leftY, rightY);
                y = startY;
                x = (truck.W - p.w) / 2;
                if (y + p.d > truck.L) return { success: false };
                leftY = y + p.d;
                rightY = y + p.d;
            }

            placedItems.push({ 
                x: x, y: y, w: p.w, d: p.d, 
                name: p.name, typeClass: p.typeClass, index: i + 1,
                weight: p.weight, owner: p.owner
            });
        }
        return { success: true, items: placedItems, usedLength: Math.max(leftY, rightY), leftY: leftY, rightY: rightY };
    }

    function showPreview(pallet) {
        if (!state.currentTruck) return;
        const previewHistory = [...state.history, pallet];
        const result = calculateLayout(state.currentTruck, previewHistory);
        hidePreview();

        if (result.success) {
            const item = result.items[result.items.length - 1];
            const el = document.createElement('div');
            el.id = 'preview-ghost';
            el.className = `pallet preview`;
            el.style.left = (item.x * currentScale) + 'px';
            el.style.top  = (item.y * currentScale) + 'px';
            el.style.width = (item.w * currentScale) + 'px';
            el.style.height = (item.d * currentScale) + 'px';
            el.innerHTML = "NEXT";
            dom.truckBed.appendChild(el);
        }
    }

    function hidePreview() {
        const ghost = document.getElementById('preview-ghost');
        if (ghost) ghost.remove();
    }

    function recalculateAndRender() {
        hidePreview();
        if (!state.currentTruck) {
             dom.truckBed.innerHTML = '';
             dom.count.textContent = '0 枚';
             dom.remainLen.textContent = '- / -';
             dom.weightDisplay.textContent = '0 / 0 kg (0%)';
             dom.breakdown.innerHTML = '(内訳)';
             return;
        }
        const result = calculateLayout(state.currentTruck, state.history);
        renderResult(result);
    }

    function updateTruckView() {
        if(!state.currentTruck) return;
        dom.truckBed.style.display = 'block';
        dom.truckBed.style.width = (state.currentTruck.W * currentScale) + 'px';
        dom.truckBed.style.height = (state.currentTruck.L * currentScale) + 'px';
    }

    function renderResult(result) {
        dom.truckBed.innerHTML = '';
        
        if(state.currentTruck) {
            const header = document.createElement('div');
            header.className = 'bed-header';
            header.innerHTML = `<span class="header-label">運転席側 (奥)</span><span class="header-name">${state.currentTruck.name} (${state.currentTruck.L}×${state.currentTruck.W})</span>`;
            dom.truckBed.appendChild(header);
        }

        const items = result.items || [];
        let totalWeight = 0;

        items.forEach(item => {
            totalWeight += (item.weight || 0);

            const el = document.createElement('div');
            let finalClass = item.typeClass;
            
            // ★Javascript追加部分：荷主がいる場合、親divにもクラスを付与してCSSで制御しやすくする
            if (item.owner && item.owner !== 'default') {
                finalClass += ` owner-${item.owner}`;
            }
            
            el.className = `pallet ${finalClass}`;
            el.style.left = (item.x * currentScale) + 'px';
            el.style.top  = (item.y * currentScale) + 'px';
            el.style.width = (item.w * currentScale) + 'px';
            el.style.height = (item.d * currentScale) + 'px';
            
            const weightText = (item.weight > 0) ? `${item.weight}kg` : '';
            
            let ownerLabel = '';
            // 既存ロジック：タグ用のHTMLも生成しておく（PCでは表示、スマホではCSSで消す）
            if (item.owner && item.owner !== 'default') {
                const ownerColorClass = `owner-${item.owner}`;
                ownerLabel = `<div class="owner-tag ${ownerColorClass}">${item.owner}</div>`;
            }

            el.innerHTML = `
                ${ownerLabel}
                <span class="p-index">${item.index}</span>
                <span class="p-size">${item.w}x${item.d}</span>
                <span class="p-weight">${weightText}</span>
            `;
            
            dom.truckBed.appendChild(el);
        });

        dom.count.textContent = items.length + " 枚";
        
        const cap = state.currentCapacity || 0;
        let percent = 0;
        if(cap > 0) {
            percent = Math.round((totalWeight / cap) * 100);
        }
        
        let weightStr = `${totalWeight} / ${cap} kg (${percent}%)`;
        dom.weightDisplay.textContent = weightStr;
        
        if (cap > 0 && totalWeight > cap) {
            dom.weightDisplay.innerHTML = `${weightStr} <span style="color:red; font-weight:bold;">(OVER)</span>`;
            dom.weightDisplay.classList.add('text-over');
        } else {
            dom.weightDisplay.classList.remove('text-over');
        }

        if(state.currentTruck) {
            const remL = Math.max(0, state.currentTruck.L - (result.leftY || 0));
            const remR = Math.max(0, state.currentTruck.L - (result.rightY || 0));
            dom.remainLen.textContent = `L:${remL} / R:${remR}`;
        }

        if (items.length === 0) {
            dom.breakdown.innerHTML = "パレットなし";
        } else {
            const counts = {};
            items.forEach(item => { 
                let name = item.name;
                if(item.owner && item.owner !== 'default') {
                    name += ` (荷主${item.owner})`;
                }
                counts[name] = (counts[name] || 0) + 1; 
            });
            let html = [];
            for (const [name, num] of Object.entries(counts)) {
                html.push(`<div>${name}: <strong>${num}</strong></div>`);
            }
            dom.breakdown.innerHTML = html.join("");
        }
    }

    function showError(msg) {
        dom.errorMsg.textContent = msg;
    }

    init();
</script>

</body>
</html>
